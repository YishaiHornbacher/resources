<style type="text/css">
	#VIS_ID_CONTAINER svg {
		overflow: hidden;
	}

	#VIS_ID_CONTAINER .node rect {
		stroke: #333;
		fill: #fff;
	}
	#VIS_ID_CONTAINER .edgePath path {
		stroke: #333;
		fill: #333;
		stroke-width: 1.5px;
	}

	#VIS_ID_CONTAINER .label {
		color: #000000;
		font-weight: normal;
		font-size: 100%;
	}
</style>

<div id="VIS_ID_CONTAINER">
	<div id="VIS_ID"></div>
</div>

<script type="text/javascript" src="d3.v3.min.js"></script>
<script type="text/javascript" src="dagre-d3.min.js"></script>

<script type="text/javascript">
	(function init() {
		var services = window.ReportingServices;

		(function () {
			/* Backward Compatibility Section */
			if (VIS_CONTEXT.props.length > 2 && VIS_CONTEXT.props && VIS_CONTEXT.props.indexOf('metric') > 0) {
				var props = {};
				try {
					var oldProps = JSON.parse(VIS_CONTEXT.props);
					props['Metric'] = oldProps['metric'];
				} catch (e) {
					props = {};
				}
				VIS_CONTEXT.props = JSON.stringify(props);
			}
		})();

		var vis = new izenda.visualization({
			id: 'VIS_ID',
			rows: VIS_ROWS,
			columns: VIS_COLUMNS,
			context: VIS_CONTEXT,
			status: VIS_FORMJSASTATUS,
			requirements: { d3: true, svg: true },
			dataLayout: 'graph',
			draw: draw
		});

		if (!vis.metrics.length) {
			throw new izenda.error.ChartSetUpError('No metric found!');
		}

		vis.initHeader({
			metrics: [{
				name: 'Metric',
				onChangeCallback: function () { }
			}]
		});

		var subscriptions = [];
		function draw() {
			subscriptions.forEach(function (subscription) { subscription.remove(); });

			if (utility.ie() > 0)
				services.updateStyle('izenda-VIS_ID-style', '.edgePath path { fill: none !important; }');


			var spendField = vis.getProperty('Metric');

			var names = [];

			function safename(name) {
				return izenda.visualization.wordwrap(name, 15);
			}

			for (var i = 0, label; i < vis.edges.length; i++) {
				if (names.indexOf(label = safename(vis.itemLabel(vis.edges[i], 0))) < 0)
					names.push(label);
				if (names.indexOf(label = safename(vis.itemLabel(vis.edges[i], 1))) < 0)
					names.push(label);
			}

			var g = new dagreD3.graphlib.Graph().setGraph({});

			names.forEach(function (name) { g.setNode(name, { label: name }); });

			for (var i = 0; i < vis.edges.length; i++) {
				g.setEdge(safename(vis.itemLabel(vis.edges[i], 0)), safename(vis.itemLabel(vis.edges[i], 1)), { label: vis.itemValue(vis.edges[i], spendField), lineInterpolate: 'basis' });
			}

			g.nodes().forEach(function (v) {
				var node = g.node(v);
				node.rx = node.ry = 10;
			});

			var svg = d3.select(vis.element.get(0))
				.append('svg:svg')
					.attr('width', vis.width)
					.attr('height', vis.height),
				inner = svg.append('svg:g');

			var zoom = d3.behavior.zoom().on('zoom', function () {
				inner.attr('transform', 'translate(' + d3.event.translate + ')' + 'scale(' + d3.event.scale + ')');
			});
			svg.call(zoom);

			var render = new dagreD3.render();

			render(inner, g);

			var initialScale = 0.75;
			zoom
				.translate([(svg.attr('width') - g.graph().width * initialScale) / 2, 20])
				.scale(initialScale)
				.event(svg);
			svg.attr('height', g.graph().height * initialScale + 40);

			subscriptions.push(vis.events.subscribe('MetricChange', function () {
				var value = vis.getProperty('Metric');

				inner
					.selectAll('g.edgeLabel')
					.each(function (element, index) {
						var text = vis.itemValue(vis.edges[index], value);
						var result = izenda.visualization.labelBBox(d3.select(this).select('g.label'), text);

						d3.select(this).select('div').html(text);
						d3.select(this)
							.selectAll(function () { return this.getElementsByTagName('foreignObject'); })
							.attr('width', result.width);
					});
			}));
		}

		draw();

		izenda.visualization.registerResize('VIS_ID', init, vis.clear);
	})();
</script>
